{% extends "base.html" %}
{% from "_filters.html" import filters_bar %}
{% block filters %}{{ filters_bar() }}{% endblock %}
{% block content %}
<div class="mb-3 text-end">
  <button type="button" class="btn btn-outline-secondary theme-toggle">Modo Escuro</button>
</div>
<div class="row g-3">
  {% for card in kpi_cards %}
  <div class="col-sm-6 col-md-4 col-lg-3">
    <div class="card h-100 {% if card.empty %}card-empty{% endif %}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="card-title">{{ card.title }}</h6>
          {% if card.badge %}<span class="badge {% if card.badge=='ok' %}badge-ok{% elif card.badge=='aten' %}badge-aten{% else %}badge-crit{% endif %}">{{ card.badge }}</span>{% endif %}
        </div>
        <div class="display-6">{{ card.value }}</div>
        {% if card.hint %}<div class="small mt-2"><span class="tooltip-small" title="{{ card.hint }}">Sem dados ainda — como resolver?</span></div>{% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<hr class="my-4">

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Top 10</strong>
        <div>
          <a href="?{{ q_toggle_top('faturamento') }}" class="btn btn-sm btn-outline-primary {% if top_metric=='faturamento' %}active{% endif %}">Faturamento</a>
          <a href="?{{ q_toggle_top('quantidade') }}" class="btn btn-sm btn-outline-primary {% if top_metric=='quantidade' %}active{% endif %}">Quantidade</a>
        </div>
      </div>
      <div class="card-body"><canvas id="chart-top10"></canvas></div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header"><strong>Participação por categoria</strong></div>
      <div class="card-body"><canvas id="chart-categoria"></canvas></div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header"><strong>Margem por categoria (30d)</strong></div>
      <div class="card-body"><canvas id="chart-margem"></canvas></div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header"><strong>Vendas por dia</strong></div>
      <div class="card-body"><canvas id="chart-dia"></canvas></div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header"><strong>Cidades vendidas</strong></div>
      <div class="card-body"><canvas id="chart-cidades"></canvas></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const qs = location.search || '';
  const charts = await fetch("{{ url_for('api_graficos') }}" + qs)
    .then(r => r.json())
    .catch(() => ({}));

  const safe = (obj, k) => (obj && obj[k]) ? obj[k] : {labels:[], values:[]};

  // Top 10 (respeita ?top=faturamento|quantidade)
  const top = safe(charts, 'top10');
  new Chart(document.getElementById('chart-top10'), {
    type: 'bar',
    data: { labels: top.labels, datasets: [{ label: top.label || 'Top 10', data: top.values }] }
  });

  // Pizza por categoria
  const cat = safe(charts, 'pie_categoria');
  new Chart(document.getElementById('chart-categoria'), {
    type: 'pie',
    data: { labels: cat.labels, datasets: [{ data: cat.values }] }
  });

  // Margem por categoria
  const margem = safe(charts, 'margem_categoria');
  new Chart(document.getElementById('chart-margem'), {
    type: 'line',
    data: { labels: margem.labels, datasets: [{ label: 'Margem %', data: margem.values }] }
  });

  // Vendas por dia
  const vd = safe(charts, 'vendas_dia');
  new Chart(document.getElementById('chart-dia'), {
    type: 'bar',
    data: { labels: vd.labels, datasets: [{ label: 'Faturamento (R$)', data: vd.values }] }
  });

  // Cidades
  const cid = safe(charts, 'cidades');
  new Chart(document.getElementById('chart-cidades'), {
    type: 'bar',
    data: { labels: cid.labels, datasets: [{ label: 'Faturamento (R$)', data: cid.values }] }
  });
});
</script>
{% endblock %}

